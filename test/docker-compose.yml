services:
  # Zookeeper - shared between plaintext and SSL
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: gom2k-test-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - gom2k-test
    profiles: ["plaintext", "ssl"]

  # Zookeeper for SSL (different port to avoid conflict)
  zookeeper-ssl:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: gom2k-test-zookeeper-ssl
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2182:2181"
    networks:
      - gom2k-test
    profiles: ["ssl"]

  # Kafka - plaintext
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: gom2k-test-kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    ports:
      - "9092:9092"
    networks:
      - gom2k-test
    profiles: ["plaintext"]

  # Kafka - SSL
  kafka-ssl:
    image: confluentinc/cp-kafka:7.4.0
    container_name: gom2k-test-kafka-ssl
    depends_on:
      - zookeeper-ssl
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-ssl:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SSL:SSL,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: SSL://localhost:9093,PLAINTEXT_HOST://localhost:9094
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      # SSL Configuration
      KAFKA_SSL_KEYSTORE_LOCATION: /certs/kafka.keystore.jks
      KAFKA_SSL_KEYSTORE_PASSWORD: testpass
      KAFKA_SSL_KEY_PASSWORD: testpass
      KAFKA_SSL_TRUSTSTORE_LOCATION: /certs/kafka.truststore.jks
      KAFKA_SSL_TRUSTSTORE_PASSWORD: testpass
      KAFKA_SSL_CLIENT_AUTH: required
    ports:
      - "9093:9093"
      - "9094:9094"
    volumes:
      - ./ssl/certs:/certs
    networks:
      - gom2k-test
    profiles: ["ssl"]

  # MQTT - plaintext
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: gom2k-test-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - gom2k-test
    profiles: ["plaintext"]

  # MQTT - SSL
  mosquitto-ssl:
    image: eclipse-mosquitto:2.0
    container_name: gom2k-test-mosquitto-ssl
    ports:
      - "8883:8883"
      - "9002:9001"
    volumes:
      - ./ssl/certs:/certs:ro
      - ./ssl/mosquitto-ssl.conf:/mosquitto/config/mosquitto.conf
    networks:
      - gom2k-test
    profiles: ["ssl"]

  # Kafka UI - plaintext
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: gom2k-test-kafka-ui
    depends_on:
      - kafka
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    ports:
      - "8080:8080"
    networks:
      - gom2k-test
    profiles: ["plaintext"]

  # Kafka UI - SSL
  kafka-ui-ssl:
    image: provectuslabs/kafka-ui:latest
    container_name: gom2k-test-kafka-ui-ssl
    depends_on:
      - kafka-ssl
    environment:
      KAFKA_CLUSTERS_0_NAME: ssl-local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-ssl:9093
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper-ssl:2181
      # SSL properties for Kafka UI
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: SSL
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_LOCATION: /certs/kafka.truststore.jks
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_PASSWORD: testpass
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_KEYSTORE_LOCATION: /certs/kafka.keystore.jks
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_KEYSTORE_PASSWORD: testpass
      KAFKA_CLUSTERS_0_PROPERTIES_SSL_KEY_PASSWORD: testpass
    ports:
      - "8081:8080"
    volumes:
      - ./ssl/certs:/certs:ro
    networks:
      - gom2k-test
    profiles: ["ssl"]

networks:
  gom2k-test:
    driver: bridge